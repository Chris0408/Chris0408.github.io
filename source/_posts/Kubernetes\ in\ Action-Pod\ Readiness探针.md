---
title: Kubernetes in Action - Pod Readiness探针使用
tags: 
- K8S
categories: 
- K8S
date: 2020-1-15
---
# Kubernetes in Action - Pod Readiness探针使用

## 一、 使用就绪探针的必要性

在K8S中， 如果Pod的标签与Pod选择器相匹配，那么Pod就将作为服务的后端。只要创建了具有适当标签的新Pod，它就成为了服务的一部分，并且请求开始被分发至该Pod。但是如果此时该Pod并没有准备好对外提供服务，有应该如何处理服务请求?

一个Pod被创建后可能需要一段时间来加载配置或者数据，或者一些初始化操作。在这种情况下，我们是不希望Pod立即开始接收请求的，特别是在已经运行中的实例可以正确且快速的处理请求的情况下，我们不希望请求被转发到正在启动的Pod中。

这是就需要使用就绪探针来解决上述问题，就绪探针会定期调用，并确定特定的Pod是否能够接受客户端请求，当容器准备就绪探测返回成功时，表示容器已经准备好接受请求，可以将Pod加入服务作为后端。

## 二、 就绪探针使用及注意事项

准备就绪的概念应该是每个容器特有的东西，应该考虑应用程序的具体情况，所以确切的就绪判定方法应该由开发人员来决定。

### 2.1 就绪探针的三种探测机制

- HTTP GET探针，向容器发送HTTP GET 请求,通过HTTP状态响应码判断容器是否准备好。
- TCP 套接字探针尝试与容器的指定端口建立TCP连接。如果连接建立成功，则认为容器准备就绪。
- Exec 探针在容器中执行任意命令，并检查命令的退出状态码。容器的状态由退出状态码决定。

### 2.2 就绪探针使用注意事项

- 启动容器时应该Pod配置一个等待时间，经过等待时间后才可以执行第一次准备就绪检查。
- 与存活探针不同，如果容器运行过程中未通过准备检查，不会被终止或者重新启动，只会从服务中删除该Pod，这是就就绪探针与存活探针最大的区别。
- 要根据应用的实际情况灵活设置探针探测频率和超时时间。
- 生产环境中务必定义合适的就绪探针，避免在服务启动但尚未准备好接收连接时，客户端请求被转发到该Pod。

## 三、 服务最小就绪时间对服务就绪探针的影响

在K8S中除了探测等待时间`initialDelaySeconds`,还有一个服务最小就绪时间`minReadySeconds` 这两个参数有什么关系？ 又如何影响服务的就绪时间？这也是需要考虑的问题。

在服务的实际启动过程中`initialDelaySeconds`运行在`minReadySeconds`之前。具体的时间计算如下：

```
如果Pod在时间点t启动，t+initialDelaySeconds 秒后就绪探针开始检测，假设在t1时间点完成了就绪检测，Pod在t1+minReadySeconds 秒后可认为完全就绪可对外提供服务，可以滚动更新下一个Pod。
```

所以，如果设置了`minReadySeconds` 参数，那么先运行`initialDelaySeconds`时间，在运行`minReadySeconds`时间Pod才能对外提供服务。



