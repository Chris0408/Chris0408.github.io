---
title: 用控制变量法排查故障
date: 2019-7-30
tags: 
- 故障排查 
- 方法论
categories: 故障排查
---
# 用控制变量法排除故障
## 问题描述
我们公司的合作伙伴提供了一个ftp地址，供开发人员下载相关对接数据。有一天开发同事突然联系我告知连接对方ftp时报`There are too many connections from your internet address.`(连接数过多)的错误。无法正常下载、回传数据。
## 处理过程
1. 第一时间想到合作伙伴那边可能做可客户端连接数限制，询问了我们的开发同事，反馈只有一人在连接，不存在并发多人。我测试了链路发现没有问题，询问了合作公司的技术，对方表示，没有对ftp连接数做限制。
2. 在阿里云vpc的出口服务器上，用tcpdump抓包目的地址为对方ftp服务的ip，并将抓包结果输出到日志文件记录一段时间的抓包内容。发现每隔一段时间就会有vpc内的一台服务器A，批量建立ftp连接并且没有断开。
3. 询问我司开发同时a服务器上的跑的服务是否有连接该ftp的接口，对方反馈一共有三个服务连接该ftp，但是全部跑的是定时任务，一般在晚上执行。并且他们义正言辞的说代码里都进行了ftp断开操作。虽然说是这么说，但此时我已严重怀疑问题就出在这三个服务上。
4. 为了尽快定位是哪个服务导致了上述问题，沟通并征得开发同事同意后。先停掉了三个服务，然后用`控制变量法`，依次重启，并手动执行定时任务。依然在出口服务器保持抓包，发现前两个服务都进行了ftp的正常连接断开操作，第三个服务一直在批量创建连接并且没有没有断开。
5. 将该情况反馈给开发同事，最终对方发现代码层面在处理ftp连接时存在bug,（循环逻辑和断开ftp连接的逻辑异常）研发同事debug修复后再次启动服务并抓包，连接正常断开。其他人通过客户端连接ftp时不在报连接数过多的问题。

# 总结
1. 控制变量法是我们中学实验中经常用到的一种方法，有时把这种方法用在故障排查上也能快速的定位到问题。
2. 当一个开发同事拍着胸脯跟你说他的代码没有BUG时，那是万万不可信的，哈哈。