---
title: Kubernetes in Action - Pod Liveness探针使用
tags: 
- K8S
categories: 
- K8S
date: 2020-1-13
---
# Kubernetes in Action - Pod Liveness探针使用

## 一、 使用存活探针的必要性

在K8S集群中，只要将Pod 调度到某个节点，该节点上的Kubelet就会运行Pod的容器，之后只要该Pod还存在，就会保持运行。 如果Pod中容器的主进程挂掉， Kubelet将自动重启容器。如果应用中存在Bug，导致主进程每隔一段时间就会崩溃一次，那么K8S每次都能重启应用重启，而应用程序本身不需要进行任何干预，这是K8S为运行在集群中的应用提供的自我修复能力。

但是，在一些特殊情况下，容器主进程没有崩溃，但应用已无法正常对外提供服务。比如，发生内存泄露的Java应用程序开始抛出`OutOfMemoryErrors`异常，但JVM进程会一直运行。这也就意味着主进程没有挂掉，K8S无法发现容器的异常，也无法自动重启容器自修自我修复。

如果有一种方法，可以使应用程序向K8S发出信号，告诉K8S应用运行异常或者无法正常对外提供服务,上面的问题就能迎刃而解了。有人提到可以在应用捕获到错误时主动退出该进程，但仔细考虑这种方法并不能解决所有的问题。例如，应用无限循环或者死锁而无法响应，为了保证应用程序可以在这种情况下也可以重新启动，必须从外部检查应用程序的运行情况，而不是依赖于应用内部的检测。所以，一般都建议在生产环境中加上Liveness探针。

## 二、 Liveness探针使用及注意事项

K8S可以通过存活探针检查容器是否还在正常运行，如果探针探测失败，K8S将定期执行探针并重启容器。

### 2.1 存活探针的三种探测机制

- HTTP GET探针针对容器的IP地址(指定的端口和路径)执行HTTP GET请求，如果收到响应，并且响应状态码不代表错误(响应码是2xx或者3xx), 则认为探测成功。如果服务返回错误的响应状态码或者无响应，则认为探测失败，容器将被重新启动。
- TCP 套接字探针尝试与容器的指定端口建立TCP连接。如果连接建立成功，建探测成功。否则容器重启。
- Exec 探针在容器中执行任意命令，并检查命令的退出状态码。如果状态码是0，则探测成功。所有其他状态码均被认为失败。

### 2.2 探针使用注意事项

- 如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其重启策略的影响(K8S默认重启策略为Always)。如果容器不提供存活探针，则默认状态为 `Success`。	
- 存活探针的附加属性，delay(延迟)、timeout(超时)、period(周期)建议在生产环境中根据应用的实际情况灵活配置，而不是使用默认值。例如`initialDelay`参数配置不恰当，会导致一些启动时间较长的的应用，在还没有启动完成的时候被探针进行探测，导致探测失败，频繁重启。
- 存活探针检测的内容也应该仔细考虑，探针检查的内容应该是应用程序内部，且不受外部因素影响。例如，数据库服务器异常，导致web服务器无法连接到后端数据库，此时前端web服务器的存活探针不应返回失败。因为问题在于后端数据库，重启web服务容器不会解决问题，反而会造成web服务容器频繁重启，直至后端数据库恢复正常。
- 保持探针的轻量级。存活探针不应该消耗过多的计算资源，并且运行不应该花太长时间。默认情况下，探测器执行频率相对较高，必须在1秒之内执行完毕。一个过重的探针会拖慢容器的运行，探针的CPU使用时间是计入容器的CPU时间配额的。